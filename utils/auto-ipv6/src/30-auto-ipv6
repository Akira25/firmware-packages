#!/bin/sh

#Kernel Tunnel Modul?
lsmod | grep '^sit ' 2&>1 1>/dev/null || exit 0

# IFUP?
[ "$ACTION" = "ifup" ] || exit 0

#Internet Gateway?
uci -p /var/state get network.$INTERFACE.gateway 2&>1 1>/dev/null || exit 0

. /etc/functions.sh

IP4_LOCAL=$(uci -p /var/state get network.$INTERFACE.ipaddr)
case $IP4_LOCAL in
	1.*) exit 0 ;;
	10.*) exit 0 ;;
	192.168.*) exit 0 ;;
	172.17.*) exit 0 ;;
esac

olsrd_remove_hna6() {
	local cfg="$1"
	local hna6="$2"
	config_get netaddr "$cfg" netaddr
	config_set "$cfg" $(date)
	[ "$netaddr" == "$hna6" ] && uci del "olsrdv6.@Hna6[""$hna6_count""]"
	hna6_count=$((hna6_count+1))
	return 0
}
olsrd_count_hna6() {
	local cfg="$1"
	hna6_count=$((hna6_count+1))
	return 0
}
olsrd_find_hna6() {
	local cfg="$1"
	local hna6="$2"
	config_get netaddr "$cfg" netaddr
	[ "$netaddr" == "$hna6" ] && hna6_find="1"
	hna6_count=$((hna6_count+1))
	return 0
}

net_find_iface() {
        local cfg="$1"
        case $cfg in
        	loopback) return 0 ;;
        	gvpn) return 0 ;;
        	wan) return 0 ;;
        esac
        interfaces="$interfaces ""$cfg"
        return 0
}
olsrd_find_plugin(){
	local cfg="$1"
	local plugin="$2"
	config_get library "$cfg" library
	case $library in
		$plugin*)
			plugin_find="1"
			return 0
		;;
	esac
	plugin_count=$((plugin_count+1))
	return 0
}

IP6_LOCAL_IP6TO4=$(printf "2002:%02x%02x:%02x%02x::1" $(echo $IP4_LOCAL | tr . ' '))
IP6_SUFIX=$(printf "2002:%02x%02x:%02x%02x" $(echo $IP4_LOCAL|sed 's/\./ /g'))
IP6_LOCAL_IP6TO4="$IP6_SUFIX""::1"

ip -6 route flush dev tun6to4 2&>1 1>/dev/null
ip link set dev tun6to4 down 2&>1 1>/dev/null
ip tunnel del tun6to4 2&>1 1>/dev/null
ip tunnel add tun6to4 mode sit remote any local $IP4_LOCAL ttl 64
#ip tunnel add tun6to4 mode sit remote any local $(ip -4 r get 1|sed -n 's/.* src //p') ttl 64
ip link set dev tun6to4 up
ip addr add "$IP6_LOCAL_IP6TO4""/16" dev tun6to4
ip route add "::192.88.99.1" dev tun6to4
ip route add "2000::/3" via "::192.88.99.1" dev tun6to4 metric 1
ip route add "::/0" via "::192.88.99.1" dev tun6to4 metric 1

config_load network
interfaces=""
config_foreach net_find_iface interface
for i in $(echo $interfaces) ; do
	#Interface
	DEV=$(uci -p/var/state get network.$i.ifname)
	#Sufix
	IP6_OLDSUFIX=$(uci -q -p/var/state get network.$i.ip6oldsufix)
	uci -p /var/state set "network.$i.ip6oldsufix=$IP6_SUFIX"
	#Uniq 4Bybte from urandom
	IP6_OLDUNIQ=$(uci -q -p/var/state get network.$i.ip6olduniq)
	IP6_UNIQ="$(head -n 1 /dev/urandom 2>/dev/null | md5sum | cut -b 1-4)"
	uci -p /var/state set "network.$i.ip6olduniq=$IP6_UNIQ"
	ip -6 addr del "$IP6_OLDSUFIX"":""$IP6_OLDUNIQ""::1/64" dev "$DEV" 2>/dev/null
	ip -6 addr add "$IP6_SUFIX"":""$IP6_UNIQ""::1/64"       dev "$DEV" 2>/dev/null
	if [ -f /etc/config/olsrdv6 ] ; then
		config_load olsrdv6
		hna6_count="0"
		config_foreach olsrd_remove_hna6 Hna6 "$IP6_OLDSUFIX"":""$IP6_OLDUNIQ""::"
		hna6_count="0"
		config_foreach olsrd_count_hna6 Hna6
		uci add olsrdv6 Hna6 >/dev/null
		uci set "olsrdv6.@Hna6[""$hna6_count""].prefix=64"
		uci set "olsrdv6.@Hna6[""$hna6_count""].netaddr=""$IP6_SUFIX"":""$IP6_UNIQ""::"
	fi
done

if [ -f /etc/config/olsrdv6 ] ; then
	config_load olsrdv6
	hna6_count="0"
	hna6_find="0"
	config_foreach olsrd_find_hna6 Hna6 "::"
	if [ "$hna6_find" == "0" ] ; then
		uci add olsrdv6 Hna6 >/dev/null
		uci set "olsrdv6.@Hna6[""$hna6_count""].prefix=0"
		uci set "olsrdv6.@Hna6[""$hna6_count""].netaddr=::"
		hna6_count=$((hna6_count+1))
	fi
	hna6_count="0"
	hna6_find="0"
	config_foreach olsrd_find_hna6 Hna6 "2000::"
	if [ "$hna6_find" == "0" ] ; then
		uci add olsrdv6 Hna6 >/dev/null
		uci set "olsrdv6.@Hna6[""$hna6_count""].prefix=3"
		uci set "olsrdv6.@Hna6[""$hna6_count""].netaddr=2000::"
	fi
	plugin_count="0"
	plugin_find="0"
	hostname=$(uname -n)
	config_foreach olsrd_find_plugin LoadPlugin "olsrd_nameservice"
	if [ "$plugin_find" == "1" ] ; then
		service=$(uci get "olsrdv6.@LoadPlugin[""$plugin_count""].service")
		uci set "olsrdv6.@LoadPlugin[""$plugin_count""].service="
		#uci add_list "olsrdv6.@LoadPlugin[""$plugin_count""].service=http://""$hostname"".olsr:80|ip6|""$IP6_SUFIX"" ""$service"
		uci add_list "olsrdv6.@LoadPlugin[""$plugin_count""].service=http://""$hostname"".olsr:80|ip6|""$IP6_SUFIX"
	fi
fi

uci commit
#[ -x /etc/init.d/radvd ] && /etc/init.d/radvd restart
#[ -x /etc/init.d/olsrd ] && /etc/init.d/olsrd restart

